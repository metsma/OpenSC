<?xml version="1.0" encoding="windows-1252"?>
<?if $(sys.BUILDARCH) = x64 ?>
  <?ifndef OpenSSL ?>
    <?define ProductName = "@OPENSC_VS_FF_PRODUCT_NAME@ Light (64bit)" ?>
  <?else ?>
    <?define ProductName = "@OPENSC_VS_FF_PRODUCT_NAME@ (64bit)" ?>
  <?endif ?>
  <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?define PlatformUpgradeCode = "{9A449570-69A2-11E0-9CC6-955B4824019B}" ?>
<?else ?>
  <?ifndef OpenSSL ?>
    <?define ProductName = "@OPENSC_VS_FF_PRODUCT_NAME@ Light" ?>
  <?else ?>
    <?define ProductName = "@OPENSC_VS_FF_PRODUCT_NAME@" ?>
  <?endif ?>
  <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
  <?define PlatformUpgradeCode = "{69428F65-B96D-458D-BB87-DBB5FDB35DCE}" ?>
<?endif ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product Name="$(var.ProductName)"
           Id="*"
           UpgradeCode="$(var.PlatformUpgradeCode)"
           Language="1033"
           Codepage="1252"
           Version="@OPENSC_VERSION_MAJOR@.@OPENSC_VERSION_MINOR@.@OPENSC_VERSION_FIX@.@OPENSC_VERSION_REVISION@"
           Manufacturer="@OPENSC_VS_FF_COMPANY_NAME@">
    <Package Description="@VS_FF_PRODUCT_NAME@ Installer"
             Comments="@OPENSC_VS_FF_COMMENTS@"
             Manufacturer="@OPENSC_VS_FF_COMPANY_NAME@"
             InstallerVersion="300"
             Languages="1033"
             Compressed="yes"
             SummaryCodepage="1252"
             InstallScope="perMachine"/>
    <!-- Setup background images -->
    <WixVariable Id="WixUIBannerBmp" Value="bannrbmp.bmp"/>
    <WixVariable Id="WixUIDialogBmp" Value="dlgbmp.bmp"/>
    <!-- Links in info -->
    <Property Id="ARPHELPLINK" Value="@PRODUCT_BUGREPORT@"/>
    <Property Id="ARPURLINFOABOUT" Value="@OPENSC_VS_FF_PRODUCT_URL@"/>
    <Property Id="ARPURLUPDATEINFO" Value="@OPENSC_VS_FF_PRODUCT_UPDATES@"/>
    <Property Id="ARPCONTACT" Value="@OPENSC_VS_FF_COMPANY_URL@"/>

    <Icon Id="OpenSC.ico" SourceFile="OpenSC.ico" />
    <Property Id="ARPPRODUCTICON" Value="OpenSC.ico" />

    <!--Custom actions-->
    <Binary Id="customactions" SourceFile="$(var.SOURCE_DIR)\win32\customactions.dll" />
    <CustomAction Id="RemoveSmartCardConfiguration" BinaryKey="customactions" DllEntry="RemoveSmartCardConfiguration" Execute="deferred" Impersonate="no"/>
    <CustomAction Id="AddSmartCardConfiguration" BinaryKey="customactions" DllEntry="AddSmartCardConfiguration" Execute="commit" Impersonate="no"/>
    <CustomAction Id="Start_pkcs11_register.exe" Execute="immediate" Impersonate="yes" Return="asyncNoWait" FileKey="pkcs11_register.exe" ExeCommand="" />

    <Media Id="1" Cabinet="OpenSC.cab" EmbedCab="yes" CompressionLevel="high"/>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Component Id="SCardSvr" Permanent="yes">
        <!-- Start SCardSvr Service during startup -->
        <RegistryValue Root="HKLM" Key="System\CurrentControlSet\Services\SCardSvr" Type="integer" Name="Start" Value="2" KeyPath="yes"/>
        <!-- Start SCardSvr Service now -->
        <!-- <ServiceControl Id="StartSCardSvrService" Name="SCardSvr" Start="install" /> -->
      </Component>

      <Directory Id="$(var.PlatformProgramFilesFolder)" Name="PFiles">
        <Directory Id="OpenSC_Project_Dir" Name="OpenSC Project">
          <!-- Most of the stuff goes to the Program Files folder -->
          <Directory Id="INSTALLDIR" Name="OpenSC">
            <!-- opensc.conf sample goes to installation directory -->
            <Component Id="opensc.conf">
              <File Source="$(var.SOURCE_DIR)\etc\opensc.conf" Name="opensc.conf" KeyPath="yes"/>
              <!-- -->
              <RegistryKey Root="HKLM" Key="Software\[Manufacturer]\OpenSC">
                <RegistryValue Type="string" Name="ConfigFile" Value="[INSTALLDIR]opensc.conf"/>
                <RegistryValue Type="string" Name="ProfileDir" Value="[INSTALLDIR]profiles"/>
                <RegistryValue Type="string" Name="SmDir" Value="[INSTALLDIR]tools"/>
                <RegistryValue Type="integer" Name="MiniDriverDebug" Value="0"/>
              </RegistryKey>
            </Component>

            <Directory Id="INSTALLDIR_MINIDRIVER" Name="minidriver">
              <Component Id="opensc_minidriver.dll">
                <File Source="$(var.SOURCE_DIR)\src\minidriver\opensc-minidriver.dll"/>
              </Component>
              <!-- install an alias for the Base smart card CSP. Using a different CSP in minidriver installation deactivate the plug and play feature
                  but not all other components like the pin change screen available after ctrl+alt+del.
                  It is because the "80000001" entry is still returning the minidriver dll.-->
              <!-- PR #2523 no longer uses "Provider = OpenSC CSP", but existing certificates in cert store 
                  may have "Provider = OpenSC CSP" so we continue to add it for backward compatibility.
                  Run: "certutil -Silent -store -user My" and look for "Provider = OpenSC CSP". -->
              <Component Id="openscBaseCSP">
                <RegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Cryptography\Defaults\Provider\OpenSC CSP">
                  <RegistryValue Type="string" Name="Image Path" Value="basecsp.dll" KeyPath="yes"/>
                  <RegistryValue Type="integer" Name="Type" Value="1"/>
                </RegistryKey>
                <!-- when the x64 installer will install x86 components on x64 plateform too
                    <?if $(sys.BUILDARCH) = x64 ?>
                    <RegistryKey Root="HKLM" Key="SOFTWARE\Wow6432Node\Microsoft\Cryptography\Defaults\Provider\OpenSC CSP">
                      <RegistryValue Type="string" Name="Image Path" Value="basecsp.dll"/>
                      <RegistryValue Type="integer" Name="Type" Value="1"/>
                    </RegistryKey>
                    <?endif?>
                    -->
              </Component>
              <Component Id="CertPropSvc" Permanent="yes">
                <!-- CertPropSvc loads the minidriver and propagates the smart card's
                     certificates to the user's certificate store, see https://technet.microsoft.com/en-us/itpro/windows/keep-secure/smart-card-certificate-propagation-service -->
                <ServiceControl Id="ControlCertPropSvcStart" Name="CertPropSvc" Start="install" Wait="no" />
                <ServiceControl Id="ControlCertPropSvcStop" Name="CertPropSvc" Stop="uninstall" Wait="yes" />
                <RegistryKey Root="HKLM" Key="SYSTEM\CurrentControlSet\Services\CertPropSvc">
                  <RegistryValue Type="integer" Name="Start" Value="2" KeyPath="yes"/>
                </RegistryKey>
              </Component>
            </Directory>

            <Directory Id="INSTALLDIR_PKCS11" Name="pkcs11">
              <Component Id="opensc_pkcs11.dll">
                <File Source="$(var.SOURCE_DIR)\src\pkcs11\opensc-pkcs11.dll"/>
              </Component>
              <Component Id="onepin_opensc_pkcs11.dll">
                <File Name="onepin-opensc-pkcs11.dll" Source="$(var.SOURCE_DIR)\src\pkcs11\opensc-pkcs11.dll"/>
              </Component>
            </Directory>

            <!-- Tools have their own folder -->
            <Directory Id="INSTALLDIR_TOOLS" Name="tools" FileSource="$(var.SOURCE_DIR)\src\tools">
              <?ifdef zlib ?>
                <Component Id="zlib1.dll">
                  <File Source="$(var.zlib)\zlib1.dll"/>
                </Component>
              <?endif ?>
              <Component Id="opensc.dll">
                <File Source="$(var.SOURCE_DIR)\src\libopensc\opensc.dll"/>
              </Component>
              <Component Id="opensc_asn1.exe">
                <File Name="opensc-asn1.exe"/>
              </Component>
              <Component Id="opensc_explorer.exe">
                <File Name="opensc-explorer.exe"/>
              </Component>
              <Component Id="opensc_tool.exe">
                <File Name="opensc-tool.exe"/>
              </Component>
              <Component Id="opensc_notify.exe">
                <File Name="opensc-notify.exe"/>
              </Component>
              <Component Id="pkcs11_tool.exe">
                <File Name="pkcs11-tool.exe"/>
              </Component>
              <Component Id="pkcs11_register.exe">
                <File Name="pkcs11-register.exe"/>
              </Component>
              <Component Id="cardos_tool.exe">
                <File Name="cardos-tool.exe"/>
              </Component>
              <Component Id="egk_tool.exe">
                <File Name="egk-tool.exe"/>
              </Component>
              <Component Id="goid_tool.exe">
                <File Name="goid-tool.exe"/>
              </Component>
              <Component Id="eidenv.exe">
                <File Name="eidenv.exe"/>
              </Component>
              <Component Id="pkcs15_tool.exe">
                <File Name="pkcs15-tool.exe"/>
              </Component>
              <Component Id="pkcs15_crypt.exe">
                <File Name="pkcs15-crypt.exe"/>
              </Component>
              <Component Id="openpgp_tool.exe">
                <File Name="openpgp-tool.exe"/>
              </Component>
              <Component Id="iasecc_tool.exe">
                <File Name="iasecc-tool.exe"/>
              </Component>
              <?ifdef OpenSSL ?>
                <Component Id="smm_local.dll">
                  <File Source="$(var.SOURCE_DIR)\src\smm\smm-local.dll"/>
                </Component>
                <Component Id="cryptoflex_tool.exe">
                  <File Name="cryptoflex-tool.exe"/>
                </Component>
                <Component Id="pkcs15_init.exe">
                  <File Name="pkcs15-init.exe"/>
                </Component>
                <Component Id="netkey_tool.exe">
                  <File Name="netkey-tool.exe"/>
                </Component>
                <Component Id="piv_tool.exe">
                  <File Name="piv-tool.exe"/>
                </Component>
                <Component Id="westcos_tool.exe">
                  <File Name="westcos-tool.exe"/>
                </Component>
                <Component Id="sc_hsm_tool.exe">
                  <File Name="sc-hsm-tool.exe"/>
                </Component>
                <Component Id="dnie_tool.exe">
                  <File Name="dnie-tool.exe"/>
                </Component>
                <Component Id="gids_tool.exe">
                  <File Name="gids-tool.exe"/>
                </Component>
                <?ifdef OpenPACE ?>
                  <Component Id="npa_tool.exe">
                    <File Name="npa-tool.exe"/>
                  </Component>
                <?endif ?>
              <?endif ?>
              <Component Id="Autostart_tools">
                <RegistryKey Root="HKMU" Key="Software\Microsoft\Windows\CurrentVersion\Run">
                  <RegistryValue Type="string" Name="pkcs11-register.exe" Value="[INSTALLDIR_TOOLS]pkcs11-register.exe" />
                </RegistryKey>
              </Component>
              <Component Id="Autostart_native_tools">
                <?if $(sys.BUILDARCH) = "x86"?>
                <Condition>
                  <![CDATA[NOT Msix64]]>
                </Condition>
                <?endif?>
                <RegistryKey Root="HKMU" Key="Software\Microsoft\Windows\CurrentVersion\Run">
                  <RegistryValue Type="string" Name="opensc-notify.exe" Value="[INSTALLDIR_TOOLS]opensc-notify.exe" />
                </RegistryKey>
              </Component>
            </Directory>
            <?ifdef OpenSSL ?>
              <Directory Id="INSTALLDIR_PROFILES" Name="profiles" FileSource="$(var.SOURCE_DIR)\src\pkcs15init">
                <Component Id="cyberflex.profile">
                  <File Name="cyberflex.profile"/>
                </Component>
                <Component Id="flex.profile">
                  <File Name="flex.profile"/>
                </Component>
                <Component Id="muscle.profile">
                  <File Name="muscle.profile"/>
                </Component>
                <Component Id="pkcs15.profile">
                  <File Name="pkcs15.profile"/>
                </Component>
                <Component Id="asepcos.profile">
                  <File Name="asepcos.profile"/>
                </Component>
                <Component Id="cardos.profile">
                  <File Name="cardos.profile"/>
                </Component>
                <Component Id="entersafe.profile">
                  <File Name="entersafe.profile"/>
                </Component>
                <Component Id="epass2003.profile">
                  <File Name="epass2003.profile"/>
                </Component>
                <Component Id="myeid.profile">
                  <File Name="myeid.profile"/>
                </Component>
                <Component Id="setcos.profile">
                  <File Name="setcos.profile"/>
                </Component>
                <Component Id="starcos.profile">
                  <File Name="starcos.profile"/>
                </Component>
                <Component Id="oberthur.profile">
                  <File Name="oberthur.profile"/>
                </Component>
                <Component Id="authentic.profile">
                  <File Name="authentic.profile"/>
                </Component>
                <Component Id="rutoken.profile">
                  <File Name="rutoken.profile"/>
                </Component>
                <Component Id="rutoken_ecp.profile">
                  <File Name="rutoken_ecp.profile"/>
                </Component>
                <Component Id="rutoken_lite.profile">
                  <File Name="rutoken_lite.profile"/>
                </Component>
                <Component Id="ias_adele_admin1.profile">
                  <File Name="ias_adele_admin1.profile"/>
                </Component>
                <Component Id="ias_adele_admin2.profile">
                  <File Name="ias_adele_admin2.profile"/>
                </Component>
                <Component Id="ias_adele_common.profile">
                  <File Name="ias_adele_common.profile"/>
                </Component>
                <Component Id="iasecc_admin_eid.profile">
                  <File Name="iasecc_admin_eid.profile"/>
                </Component>
                <Component Id="iasecc_generic_oberthur.profile">
                  <File Name="iasecc_generic_oberthur.profile"/>
                </Component>
                <Component Id="iasecc_generic_pki.profile">
                  <File Name="iasecc_generic_pki.profile"/>
                </Component>
                <Component Id="iasecc.profile">
                  <File Name="iasecc.profile"/>
                </Component>
                <Component Id="schsm.profile">
                  <File Name="sc-hsm.profile"/>
                </Component>
                <Component Id="openpgp.profile">
                  <File Name="openpgp.profile"/>
                </Component>
                <Component Id="isoApplet.profile">
                  <File Name="isoApplet.profile"/>
                </Component>
                <Component Id="gids.profile">
                  <File Name="gids.profile"/>
                </Component>
              </Directory>
            <?endif ?>
            <?ifdef OpenPACE ?>
              <Directory Id="INSTALLDIR_CVC" Name="cvc" FileSource="$(var.SOURCE_DIR)\etc">
                <Component Id="DESRCACC100001">
                  <File Name="DESRCACC100001"/>
                </Component>
                <Component Id="DESCHSMCVCA00001">
                  <File Name="DESCHSMCVCA00001"/>
                </Component>
              </Directory>
            <?endif ?>
          </Directory>
          <Directory Id="PKCS11SPYINSTALLDIR" Name="PKCS11-Spy">
            <Component Id="pkcs11_spy.dll">
              <File Source="$(var.SOURCE_DIR)\src\pkcs11\pkcs11-spy.dll"/>
              <RegistryKey Root="HKLM" Key="Software\[Manufacturer]\PKCS11-Spy">
                <RegistryValue Type="string" Name="Module" Value="[INSTALLDIR_PKCS11]opensc-pkcs11.dll"/>
                <RegistryValue Type="string" Name="Output" Value="%TEMP%\pkcs11-spy.log"/>
              </RegistryKey>
            </Component>
          </Directory>
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Directory Id="ProgramMenuDir" Name="OpenSC Project">
          <Component Id="ProgramMenuDir">
            <util:InternetShortcut Id="OnlineDocumentationShortcut" Name="OpenSC wiki" Target="https://github.com/OpenSC/OpenSC/wiki"/>
            <RemoveFolder Id="ProgramMenuDir" On="uninstall"/>
            <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
          </Component>
        </Directory>
      </Directory>
    </Directory>
    <!-- Set up the features  -->
    <Feature Id="Complete" Level="1" Title="OpenSC software suite" Display="expand">
      <Feature Id="OpenSC_core" Level="1" Title="Core components" Description="Core Libraries and configuration files used by all other components." Absent="disallow">
        <ComponentRef Id="SCardSvr"/>
        <?ifdef zlib ?>
          <ComponentRef Id="zlib1.dll"/>
        <?endif ?>
        <ComponentRef Id="opensc.conf"/>
        <?ifdef OpenSSL ?>
          <ComponentRef Id="smm_local.dll"/>
        <?endif ?>
        <?ifdef OpenPACE ?>
          <ComponentRef Id="DESRCACC100001"/>
          <ComponentRef Id="DESCHSMCVCA00001"/>
        <?endif ?>
      </Feature>
      <Feature Id="OpenSC_pkcs11" Level="1" Title="PKCS#11 module" Description="Security module that can be used by most cross-platform software, for example Firefox, Thunderbird, OpenVPN, etc.">
        <ComponentRef Id="opensc_pkcs11.dll"/>
        <ComponentRef Id="onepin_opensc_pkcs11.dll"/>
      </Feature>
      <Feature Id="PKCS11_spy" Level="1" Title="PKCS#11 Spy module" Description="PKCS#11 module for debugging library invocations.">
        <ComponentRef Id="pkcs11_spy.dll"/>
      </Feature>
      <Feature Id="OpenSC_minidriver" Level="1" Title="Smart card minidriver" Description="Security module that can be used by native Windows applications, for example Edge, Chrome, Microsoft Office, Acrobat Reader, etc.">
        <ComponentRef Id="opensc_minidriver.dll"/>
        <ComponentRef Id="openscBaseCSP"/>
        <ComponentRef Id="CertPropSvc"/>
      </Feature>
      <!-- Tools and profiles are for personalization -->
      <Feature Id="OpenSC_tools" Level="1" Title="Command line tools" Description="OpenSC tools for debugging and smart card personalization.">
        <ComponentRef Id="opensc.dll"/>
        <ComponentRef Id="opensc_asn1.exe"/>
        <ComponentRef Id="opensc_explorer.exe"/>
        <ComponentRef Id="opensc_tool.exe"/>
        <ComponentRef Id="opensc_notify.exe"/>
        <ComponentRef Id="pkcs11_tool.exe"/>
        <ComponentRef Id="pkcs11_register.exe"/>
        <ComponentRef Id="cardos_tool.exe"/>
        <ComponentRef Id="egk_tool.exe"/>
        <ComponentRef Id="goid_tool.exe"/>
        <ComponentRef Id="eidenv.exe"/>
        <ComponentRef Id="pkcs15_tool.exe"/>
        <ComponentRef Id="pkcs15_crypt.exe"/>
        <ComponentRef Id="openpgp_tool.exe"/>
        <ComponentRef Id="iasecc_tool.exe"/>
        <?ifdef OpenSSL ?>
          <ComponentRef Id="cryptoflex_tool.exe"/>
          <ComponentRef Id="pkcs15_init.exe"/>
          <ComponentRef Id="netkey_tool.exe"/>
          <ComponentRef Id="piv_tool.exe"/>
          <ComponentRef Id="westcos_tool.exe"/>
          <ComponentRef Id="sc_hsm_tool.exe"/>
          <ComponentRef Id="dnie_tool.exe"/>
          <ComponentRef Id="gids_tool.exe"/>
          <?ifdef OpenPACE ?>
            <ComponentRef Id="npa_tool.exe"/>
          <?endif ?>
          <ComponentRef Id="cyberflex.profile"/>
          <ComponentRef Id="flex.profile"/>
          <ComponentRef Id="muscle.profile"/>
          <ComponentRef Id="pkcs15.profile"/>
          <ComponentRef Id="asepcos.profile"/>
          <ComponentRef Id="cardos.profile"/>
          <ComponentRef Id="entersafe.profile"/>
          <ComponentRef Id="epass2003.profile"/>
          <ComponentRef Id="myeid.profile"/>
          <ComponentRef Id="setcos.profile"/>
          <ComponentRef Id="starcos.profile"/>
          <ComponentRef Id="oberthur.profile"/>
          <ComponentRef Id="authentic.profile"/>
          <ComponentRef Id="rutoken.profile"/>
          <ComponentRef Id="rutoken_ecp.profile"/>
          <ComponentRef Id="rutoken_lite.profile"/>
          <ComponentRef Id="ias_adele_admin1.profile"/>
          <ComponentRef Id="ias_adele_admin2.profile"/>
          <ComponentRef Id="ias_adele_common.profile"/>
          <ComponentRef Id="iasecc_admin_eid.profile"/>
          <ComponentRef Id="iasecc_generic_oberthur.profile"/>
          <ComponentRef Id="iasecc_generic_pki.profile"/>
          <ComponentRef Id="iasecc.profile"/>
          <ComponentRef Id="schsm.profile"/>
          <ComponentRef Id="openpgp.profile"/>
          <ComponentRef Id="isoApplet.profile"/>
          <ComponentRef Id="gids.profile"/>
        <?endif ?>
        <Feature Id="OpenSC_autostart" Level="1" Title="Autostart entries" Description="After login, automatically register the PKCS#11 module and start smart card notifications.">
          <ComponentRef Id="Autostart_tools"/>
          <ComponentRef Id="Autostart_native_tools"/>
        </Feature>
      </Feature>
      <Feature Id="OpenSC_menu" Level="1" Title="Start menu entries" Description="Add documentation links to the start menu.">
        <ComponentRef Id="ProgramMenuDir"/>
      </Feature>
    </Feature>
    <UI Id='Mondo'>
      <UIRef Id="WixUI_Mondo"/>
      <UIRef Id="WixUI_ErrorProgressText"/>

      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="SetupTypeDlg" Order="3">1</Publish>
      <Publish Dialog="SetupTypeDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="3">1</Publish>
    </UI>

    <InstallExecuteSequence>
      <!-- UnInstall sequence -->
      <!-- clean the smart card registration (only at uninstall of the feature OpenSC_minidriver) -->
      <Custom Action='RemoveSmartCardConfiguration' Before="RemoveFiles">
        <![CDATA[(NOT UPGRADINGPRODUCTCODE) AND (&OpenSC_minidriver=2) AND (!OpenSC_minidriver=3) ]]>
      </Custom>

      <!-- Install sequence -->
      <!-- add the smart card registration (only at install of the feature OpenSC_minidriver) -->
      <Custom Action='AddSmartCardConfiguration' Before="RemoveSmartCardConfiguration">
        <![CDATA[ (NOT (REMOVE="ALL")) AND (NOT UPGRADINGPRODUCTCODE) AND (&OpenSC_minidriver=3) AND (!OpenSC_minidriver=2) ]]>
      </Custom>

      <!-- smart pkcs11-register.exe (only at install of the feature OpenSC_autostart) -->
      <Custom Action="Start_pkcs11_register.exe" After="InstallFinalize">
        <![CDATA[ (NOT (REMOVE="ALL")) AND (NOT UPGRADINGPRODUCTCODE) AND (&OpenSC_autostart=3) AND (!OpenSC_autostart=2) ]]>
      </Custom>

    </InstallExecuteSequence>
  </Product>
</Wix>
